# trigger:
# - master

# pool:
#   name: agent-pool  # Your self-hosted Linux agent pool

# steps:
# # Step 1: Detect JDK 11 and set JAVA_HOME_11_X64 safely
# - script: |
#     JAVAC_PATH=$(which javac)
#     if [ -z "$JAVAC_PATH" ]; then
#       echo "ERROR: javac not found. Make sure JDK 11 is installed and in PATH."
#       exit 1
#     fi

#     # Resolve full path safely
#     JAVAC_REAL=$(readlink -f "$JAVAC_PATH")
#     JDK_PATH=$(dirname $(dirname "$JAVAC_REAL"))

#     # Set pipeline variable
#     echo "##vso[task.setvariable variable=JAVA_HOME_11_X64]$JDK_PATH"
#     echo "JAVA_HOME_11_X64 set to $JDK_PATH"

#     # Verify
#     "$JDK_PATH/bin/java" -version
#     "$JDK_PATH/bin/javac" -version
#   displayName: 'Set JAVA_HOME_11_X64 safely'

# # Step 2: Maven build and test
# - task: Maven@4
#   inputs:
#     mavenPOMFile: 'pom.xml'  # Adjust if your pom.xml is in a subfolder
#     mavenOptions: '-Xmx3072m'
#     javaHomeOption: 'JDKVersion'
#     jdkVersionOption: '11'
#     jdkArchitectureOption: 'x64'
#     publishJUnitResults: true
#     testResultsFiles: '**/surefire-reports/TEST-*.xml'
#     goals: 'package'

# # Step 3: Auto-detect Maven target folder
# - script: |
#     TARGET_DIR=$(find $(System.DefaultWorkingDirectory) -type d -name target | head -n 1)
#     if [ -z "$TARGET_DIR" ]; then
#       echo "ERROR: Maven target folder not found"
#       exit 1
#     fi
#     echo "Found target folder: $TARGET_DIR"
#     echo "##vso[task.setvariable variable=TARGET_DIR]$TARGET_DIR"
#   displayName: 'Find Maven target folder'

# # Step 4: Publish build artifacts
# - task: PublishBuildArtifacts@1
#   inputs:
#     pathToPublish: '$(TARGET_DIR)'
#     artifactName: 'java-app'
#     publishLocation: 'Container'
# - task: CopyFiles@2
#   inputs:
#     Contents: '**/*.war'
#     TargetFolder: '$(build.artifactstagingdirectory)'
# - task: PublishBuildArtifacts@1
#   inputs:
#     PathtoPublish: '$(Build.ArtifactStagingDirectory)'
#     ArtifactName: 'warfile'
#     publishLocation: 'Container'

trigger:
- master

pool:
  name: agent-pool  # Your self-hosted Linux agent pool

stages:
# ---------------- Build Stage ----------------
- stage: Build
  displayName: "Build Stage"
  jobs:
  - job: BuildJob
    displayName: "Build with Maven"
    steps:
    # Step 1: Detect JDK 11 manually
    - script: |
        JAVAC_PATH=$(which javac)
        if [ -z "$JAVAC_PATH" ]; then
          echo "ERROR: javac not found. Make sure JDK 11 is installed and in PATH."
          exit 1
        fi
        JAVAC_REAL=$(readlink -f "$JAVAC_PATH")
        JDK_PATH=$(dirname $(dirname "$JAVAC_REAL"))
        echo "##vso[task.setvariable variable=JAVA_HOME_11_X64]$JDK_PATH"
        echo "JAVA_HOME_11_X64 set to $JDK_PATH"
        "$JDK_PATH/bin/java" -version
        "$JDK_PATH/bin/javac" -version
      displayName: 'Set JAVA_HOME manually'

    # Step 2: Maven build
    - task: Maven@4
      inputs:
        mavenPOMFile: 'pom.xml'
        mavenOptions: '-Xmx3072m'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '11'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        goals: 'clean package'

    # Step 3: Copy WAR to staging
    - task: CopyFiles@2
      inputs:
        Contents: '**/target/*.war'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/war'
        flattenFolders: true

    # Step 4: Validate WAR structure
    - script: |
        WAR_FILE=$(find "$(Build.ArtifactStagingDirectory)/war" -name "*.war" | head -n 1)
        if [ -z "$WAR_FILE" ]; then
          echo "ERROR: No WAR file found"
          exit 1
        fi
        unzip -l "$WAR_FILE" | grep "WEB-INF/" > /dev/null || { echo "ERROR: WEB-INF missing"; exit 1; }
        unzip -l "$WAR_FILE" | grep ".class" > /dev/null || { echo "ERROR: No classes found"; exit 1; }
        echo "WAR validation passed"
      displayName: "Validate WAR structure"

    # Step 5: Rename WAR to ROOT.war
    - script: |
        WAR_FILE=$(find "$(Build.ArtifactStagingDirectory)/war" -name "*.war" | head -n 1)
        mv "$WAR_FILE" "$(Build.ArtifactStagingDirectory)/war/ROOT.war"
        echo "Renamed WAR to ROOT.war"
      displayName: "Rename WAR to ROOT.war"

    # Step 6: Publish artifact
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/war'
        ArtifactName: 'warfile'
        publishLocation: 'Container'

# ---------------- Release Stage ----------------
- stage: Release
  displayName: "Release Stage"
  dependsOn: Build
  jobs:
  - deployment: DeployJob
    displayName: "Deploy to Azure Web App"
    environment: Dev
    strategy:
      runOnce:
        deploy:
          steps:
          # Step 1: Download WAR artifact
          - download: current
            artifact: warfile

          # Step 2: Clean wwwroot on App Service
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'servcon'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Cleaning /home/site/wwwroot..."
                az webapp ssh --name lazdevops --resource-group az-devops-rg --command "rm -rf /home/site/wwwroot/*"
            displayName: "Clean App Service wwwroot"

          # Step 3: Deploy ROOT.war
          - task: AzureWebApp@1
            inputs:
              azureSubscription: 'servcon'
              appType: 'webAppLinux'
              appName: 'lazdevops'
              package: '$(Pipeline.Workspace)/warfile/ROOT.war'
              runtimeStack: 'TOMCAT|11-java11'
            displayName: "Deploy ROOT.war to Azure Web App"

          # Step 4: Optional - tail logs
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'servcon'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Streaming Tomcat logs..."
                az webapp log tail --name lazdevops --resource-group az-devops-rg
            displayName: "Stream App Logs"
